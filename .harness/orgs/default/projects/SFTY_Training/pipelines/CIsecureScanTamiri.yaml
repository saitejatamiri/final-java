pipeline:
  name: CI-secureScan-Tamiri
  identifier: CIsecureScanTamiri
  projectIdentifier: SFTY_Training
  orgIdentifier: default
  tags: {}
  properties:
    ci:
      codebase:
        connectorRef: GitHubTamirijavarepo
        build: <+input>
  stages:
    - stage:
        name: build-scan
        identifier: buildscan
        description: ""
        type: CI
        spec:
          cloneCodebase: true
          caching:
            enabled: true
            override: false
          platform:
            os: Linux
            arch: Amd64
          runtime:
            type: Cloud
            spec: {}
          execution:
            steps:
              - parallel:
                  - step:
                      type: Gitleaks
                      name: Gitleaks_1
                      identifier: Gitleaks_1
                      spec:
                        mode: orchestration
                        config: default
                        target:
                          type: repository
                          detection: auto
                        advanced:
                          log:
                            level: info
                          args:
                            cli: " gitleaks detect --source . -r gitleaks-report.json json"
                      failureStrategies:
                        - onFailure:
                            errors:
                              - AllErrors
                            action:
                              type: MarkAsSuccess
                  - step:
                      type: Run
                      name: Run_2
                      identifier: Run_2
                      spec:
                        connectorRef: DockerTamiri
                        image: zricethezav/gitleaks:latest
                        shell: Sh
                        command: |-
                          gitleaks detect \
                                    --source=. \
                                    --report-format=json \
                                    --report-path=/harness/gitleaks-report.json \
                                    --exit-code=0  # Override exit code
              - step:
                  type: Run
                  name: Var_test
                  identifier: Var_test
                  spec:
                    shell: Sh
                    command: |-
                      echo <+pipeline.executionId>        # Output example: 1234-5678-abcd
                      echo <+pipeline.sequenceId>         # Output example: 16
                      echo <+stage.name>                  # Output example: dev
                      echo <+service.name>                # Output example: nginx
                      echo <+artifacts.primary.image>     # Output example: index.docker.io/library/nginx:stable
                      echo <+artifacts.primary.imagePath>
              - step:
                  type: Run
                  name: Run_3
                  identifier: Run_3
                  spec:
                    shell: Sh
                    command: |-
                      ls -a
                      #cat gitleaks-report.json
                      cat /harness/gitleaks-report.json | jq .
              - step:
                  type: Run
                  name: mvn_build
                  identifier: mvn_build
                  spec:
                    shell: Sh
                    command: |-
                      ls -a
                      mvn clean package
  variables:
    - name: JAR_PATH
      type: String
      description: ""
      required: false
      value: /harness/target/java-sample-app-1.0.0.jar
